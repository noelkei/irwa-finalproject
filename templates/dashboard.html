{% extends "base.html" %}
{% block page_title %}Dashboard{% endblock %}
{% block header %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.2/chart.min.js"></script>
{% endblock %}
{% block content %}
<h3>Dashboard</h3>

<h4>Key Indicators</h4>
<ul>
    <li>Total sessions: {{ kpis.total_sessions }}</li>
    <li>Total requests: {{ kpis.total_requests }}</li>
    <li>Total clicks: {{ kpis.total_clicks }}</li>
    <li>Average dwell time (s): {{ "%.2f"|format(kpis.avg_dwell_time) }}</li>
</ul>

<hr>

<h4>Top Visited Products</h4>
{% if visited_docs %}
<ul>
    {% for item in visited_docs %}
    <li><strong>{{ item.count }} views</strong> — {{ item.description }}</li>
    {% endfor %}
</ul>
{% else %}
<p>No product views yet.</p>
{% endif %}

<hr>

<h4>Top Search Queries</h4>
{% if top_queries %}
<ul>
    {% for q,count in top_queries %}
    <li>{{ q }} — {{ count }}</li>
    {% endfor %}
</ul>
{% else %}
<p>No queries yet.</p>
{% endif %}

<hr>

<h4>Top Search Terms</h4>
{% if top_terms %}
<ul>
    {% for t,count in top_terms %}
    <li>{{ t }} — {{ count }}</li>
    {% endfor %}
</ul>
{% else %}
<p>No query term data.</p>
{% endif %}

<hr>

<h4>Browser Usage</h4>
{% if browser_labels %}
<canvas id="browserChart"></canvas>
<script>
new Chart(document.getElementById('browserChart'), {
    type: 'pie',
    data: {
        labels: {{ browser_labels|tojson }},
        datasets: [{
            data: {{ browser_counts|tojson }},
            backgroundColor: ['#ff6384','#36a2eb','#ffce56','#8affc1','#c9cbff','#ffb1c1']
        }]
    }
});
</script>
{% else %}
<p>No browser info.</p>
{% endif %}

<hr>

<h4>Device Types</h4>
{% if device_labels %}
<canvas id="deviceChart"></canvas>
<script>
new Chart(document.getElementById('deviceChart'), {
    type: 'pie',
    data: {
        labels: {{ device_labels|tojson }},
        datasets: [{
            data: {{ device_counts|tojson }},
            backgroundColor: ['#6495ED','#FFD700']
        }]
    }
});
</script>
{% else %}
<p>No device info.</p>
{% endif %}

<hr>

<!-- ⭐ NEW: Ranking distribution of clicked documents -->
<h4>Click Ranking Distribution</h4>
{% if click_rank_labels %}
<canvas id="rankChart"></canvas>
<script>
new Chart(document.getElementById('rankChart'), {
    type: 'bar',
    data: {
        labels: {{ click_rank_labels|tojson }},
        datasets: [{
            label: 'Clicks by rank',
            data: {{ click_rank_counts|tojson }},
            backgroundColor: '#36A2EB'
        }]
    },
    options: { scales: { y: { beginAtZero: true } } }
});
</script>
{% else %}
<p>No rank data yet.</p>
{% endif %}

<hr>

<!-- ⭐ NEW: Dwell time distribution -->
<h4>Dwell Time Distribution (seconds)</h4>
{% if dwell_labels %}
<canvas id="dwellChart"></canvas>
<script>
new Chart(document.getElementById('dwellChart'), {
    type: 'bar',
    data: {
        labels: {{ dwell_labels|tojson }},
        datasets: [{
            label: 'Dwell time (s)',
            data: {{ dwell_counts|tojson }},
            backgroundColor: '#FF9800'
        }]
    },
    options: { scales: { y: { beginAtZero: true } } }
});
</script>
{% else %}
<p>No dwell time recorded yet.</p>
{% endif %}

<hr>

<!-- ⭐ NEW: Clicks per hour -->
<h4>Clicks per Hour of Day</h4>
{% if click_hour_labels %}
<canvas id="hourChart"></canvas>
<script>
new Chart(document.getElementById('hourChart'), {
    type: 'line',
    data: {
        labels: {{ click_hour_labels|tojson }},
        datasets: [{
            label: 'Clicks',
            data: {{ click_hour_counts|tojson }},
            borderColor: '#4CAF50',
            fill: false
        }]
    }
});
</script>
{% else %}
<p>No click-hour data yet.</p>
{% endif %}

<hr>

<h4>Document Views Chart</h4>
<iframe src="/plot_number_of_views" width="600" height="400" style="border:none;"></iframe>

{% endblock %}
